<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>LibreTV Player v2.0</title>

  <!-- HLS 解码 (最新版 1.5.0) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.0/dist/hls.min.js"></script>

  <!-- ArtPlayer 最新版 (5.3.0) -->
  <script src="https://cdn.jsdelivr.net/npm/artplayer@5.3.0/dist/artplayer.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      height: 100%;
      font-family: "Segoe UI", sans-serif;
    }
    #player {
      width: 100vw;
      height: 100vh;
    }
    /* 加载动画 */
    #loading {
      position: absolute;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000;
      color: #23ade5;
      font-size: 16px;
      letter-spacing: 1px;
      z-index: 9;
    }
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-top: 3px solid #23ade5;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 0.8s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 快捷键提示浮窗 */
    .shortcut-hint {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      padding: 10px 20px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
      z-index: 99;
    }
    .shortcut-hint svg {
      width: 24px;
      height: 24px;
      margin-right: 8px;
    }
    .shortcut-hint.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
  </style>
</head>

<body>
  <div id="loading">
    <div class="spinner"></div>
    <span>正在加载视频...</span>
  </div>

  <div id="player"></div>

  <!-- 快捷键提示浮窗 -->
  <div class="shortcut-hint" id="shortcutHint">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="shortcutIcon">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
    </svg>
    <span id="shortcutText"></span>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const videoUrl = params.get('url');

    if (!videoUrl) {
      document.body.innerHTML = `
        <p style="color:white;text-align:center;margin-top:40vh;">
          ⚠️ 未检测到视频 URL 参数<br><br>
          示例：<br><code>?url=https://example.com/video.m3u8</code>
        </p>`;
    } else {
      const progressKey = 'libretv_progress_' + videoUrl;
      const lastTime = parseFloat(localStorage.getItem(progressKey)) || 0;

      window.art = new Artplayer({
        container: '#player',
        url: videoUrl,
        title: decodeURIComponent(videoUrl.split('/').pop()),
        theme: '#23ade5',
        fullscreen: true,
        lock: true,
        autoOrientation: true,
        useGesture: true,
        playbackRate: true,
        aspectRatio: true,
        pip: true,
        mutex: true,
        setting: true,
        moreVideoAttr: {
          playsInline: true,
          webkitPlaysinline: true,
          x5VideoPlayerType: "h5",
          x5VideoPlayerFullscreen: false,
        },
        customType: {
          m3u8: function(video, url) {
            if (Hls.isSupported()) {
              const hls = new Hls();
              hls.loadSource(url);
              hls.attachMedia(video);
              hls.on(Hls.Events.MANIFEST_PARSED, function () {
                document.getElementById('loading').style.display = 'none';
              });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
              video.src = url;
              document.getElementById('loading').style.display = 'none';
            } else {
              document.body.innerHTML = '<p style="color:white;text-align:center;margin-top:40vh;">❌ 当前浏览器不支持播放该视频</p>';
            }
          },
        },
      });

      // 记忆播放进度
      art.on('ready', () => {
        if (lastTime > 5 && lastTime < art.duration - 5) {
          art.notice.show('上次播放到 ' + Math.floor(lastTime) + ' 秒');
          art.currentTime = lastTime;
        }
      });

      art.on('video:timeupdate', () => {
        localStorage.setItem(progressKey, art.currentTime);
      });

      art.on('video:ended', () => {
        localStorage.removeItem(progressKey);
      });

      // 隐藏加载动画
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
      }, 2000);
    }

    // 快捷键提示逻辑
    function showShortcutHint(text, iconPath) {
      const hint = document.getElementById('shortcutHint');
      const icon = document.getElementById('shortcutIcon');
      const textEl = document.getElementById('shortcutText');

      textEl.textContent = text;
      if (iconPath) icon.querySelector('path').setAttribute('d', iconPath);

      hint.classList.add('show');
      clearTimeout(hint._timeout);
      hint._timeout = setTimeout(() => hint.classList.remove('show'), 1500);
    }

    document.addEventListener('keydown', (e) => {
      if (!window.art) return;

      switch (e.key) {
        case 'ArrowLeft':
          art.currentTime = Math.max(0, art.currentTime - 10);
          showShortcutHint('快退 10 秒', 'M15 19l-7-7 7-7');
          break;
        case 'ArrowRight':
          art.currentTime = Math.min(art.duration, art.currentTime + 10);
          showShortcutHint('快进 10 秒', 'M9 5l7 7-7 7');
          break;
        case 'ArrowUp':
          art.volume = Math.min(1, art.volume + 0.1);
          showShortcutHint('音量 +10%', 'M3 9v6h4l5 5V4L7 9H3z');
          break;
        case 'ArrowDown':
          art.volume = Math.max(0, art.volume - 0.1);
          showShortcutHint('音量 -10%', 'M3 9v6h4l5 5V4L7 9H3z');
          break;
        case ' ':
          art.toggle();
          showShortcutHint(art.playing ? '暂停' : '播放', 'M6 4l12 8-12 8V4z');
          break;
      }
    });
  </script>
</body>
</html>
